<!DOCTYPE html>
<html>
<head>	
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Twlyr - Share a Song!</title>

	<link href="bootstrap/css/bootstrap.css" rel="stylesheet"></link>
	<link href='main.css' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Berkshire+Swash|Courgette|Open+Sans' rel='stylesheet' type='text/css'>

	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>

	<script src="js/vagalume.js" charset="utf-8"></script>
	<script src="js/boxes.js" charset="utf-8"></script>
	<script src="js/mustache.js"></script>

	<style>

	.wrap-left {
		width: 380px;
		float: left;
		padding-right: 20px;
	}

	.wrap-right {
		float: right;
		width: 400px;
	}
	
	.boing {
		margin: 200px 0;
	}

	.separator {
		border-top: 3px dotted white;
	}

	/* overwrite bootstrap's .container */
	.container.black {
		width: auto;
		margin-top: 20px;
		background: #777;
		background: url(images/blackbg.png);
		box-shadow: inset 0 10px 40px -10px black;
	}
	.container.black:not(:empty) {
		border-top: 3px dotted white;
		borsder-bottom: 3px dotted white;
	}

	.box-wrapper {
		margin: 0 auto;
		margin-bottom: 30px;
		width: 800px;
	}

	.music-info-wrapper > * {
		display: inline-block;
		color: #222;
		font: 14px/20px "Open Sans";
	}

	.music-info-wrapper img {
		margin-right: 20px;
		vertical-align: top;
		box-shadow: 0 0 4px black;
	}

	
	.box-wrapper .lyrics-box h2 {
		margin-bottom: 40px;
	}

	.box-wrapper .error-box { margin: 30px; }
	.box-wrapper .error-box h2 { margin-bottom: 10px; }
	.lyrics-box {
		margin: 40px 0;
	}

	</style>

</head>
<body>

<div class="beta-strip">Beta v1.0</div>

<div class="container">
	<div class="boing">
		<h1 class="twlyr">Twlyr</h1>
		<h3 class="desc">share a verse on Twitter!</h3>
		
		<div id="searchbar">
			<form class="form-search">
				<input type="text" autocomplete="off" placeholder="choose an artist" class="input-medium search-query" id="search-artist">
				<input type="text" autocomplete="off" placeholder="choose a song" class="input-medium search-query" id="search-music">
				<button type="submit" class="btn btn-warning btn-large">Search</button>
			</form>
		</div>
	<footer>
		2012 &reg created by <a href="http://twitter.com/#!/f03lipe">@f03lipe</a> and <a href="http://twitter.com/#!/gabriel_vianna">@gabrielvianna</a>
	</footer>
	</div>

</div>

<div class="container black"></div>

<script id="lyrics-box-html" type="text/html">
	<div class="box-wrapper">

		<div class="box lyrics-box">
		<h2>Hey, we found something!</h2>
			<div class="wrap-left">
				<div class="music-info-wrapper" style="margin-bottom: 20px">
					<img src="{{pic-url}}"></img>
					<div>
						artist: <h3 class="artist-name">{{artist-name}}</h3>
						song: <h3 class="song-name">{{song-name}}</h3>
					</div>
				</div>


				<div class="tweet-box">
					<textarea class="tweet" placeholder="select the lyrics on the right to tweet..."></textarea>

					<div class="align-line">
						<div class="twtcounter">0</div>
						<button class="btn btn-success tweet-button" onClick="openTweetPopup()">Tweet</button>
					</div>
				</div>
			</div>
			<div class="wrap-right">
				<h5>{{artist-name}}'s {{song-name}} lyrics:</h5> <!--' -->
				<div class="lyrics"></div>
			</div>
		</div>

		<div class="separsator"></div>
	</div>
</script>

<script id="error-box-html" type="text/html">
	<div class="box-wrapper">
		<div class="box error-box">
			{{#unknown-error}}
				<h2>Unknown Error</h2>
				<h3>Something hapenned, but...</h3>
			{{/unknown-error}}

			{{#artist-404}}
				<h2>Artist '{{artist-name}}' was not found</h2> <!-- ' -->
				<h3>We're sorry. You sure you're spelling it correctly?</h3> <!-- ' -->
			{{/artist-404}}

			{{#music-404}}
				<h2>Song not found</h2>
				<h3>We couldn't find {{music-name}} by {{artist-name}}. </h3><!-- ' -->
			{{/music-404}}

			{{#general-error}}
				<h2>{{general-error}}</h2>
			{{/general-error}}
		</div>
	</div>
</script>

<script id="BOINGartist-box-html" type="text/html">
		
	(function () {
	    function getArtistUrl() {
	        if (!window.location.hash)
	            return '';
	        return 'http://www.vagalume.com.br/' + window.location.hash.slice(2).split(':')[1] + '/';
	    }
	    
	    vagalume.getMusicListFromArtistUrl(
	        getArtistUrl(),
	        function (data) {
	            if (data.length === 0) {
	                window.location.hash = '#!error:2';
	                return;
	            }
	            for (var i = 0; i < data.length; i++) {
	                $('#content ol').append(
	                    $('<li>').append(
	                        $('<a>').attr('href', '#!' + data[i].id).append(
	                            data[i].name
	                        )
	                    )
	                );
	            }
	        }
	    );
	}());
</script>

<script>

SearchBar = new SearchBar();

//////////////////

// format: #!<artist>:<song>
// undefined songs: #!<artist>:?
// undefined artists: #!:<song>
// errors have no urls

function scrollToContent () {
	var p = document.querySelector(".container.black").offsetTop;
	$('html').animate({scrollTop:p}, 1000); // IE, FF
	$('body').animate({scrollTop:p}, 1000); // chrome, don't know if safary works	
}

function updateForm (hashObj) {
	document.querySelector("#search-artist").value = hashObj.artist;
	document.querySelector("#search-music").value = hashObj.music;
}

document.querySelector("form.form-search").onsubmit = function () {
	var artist = document.querySelector("#search-artist").value.toLowerCase().trim(),
		music = document.querySelector("#search-music").value.toLowerCase().trim();
	substituteHash("#!"+escape(artist)+":"+escape(music));
	return false;
}

function parseHash (hashUrl) {
	// Return {String artist, String music} based on location.hash.
	var hash = (hashUrl || location.hash).replace(/^#\!?/, ''); // remove #! from beginning
	if (hash === 'error') {
		// Remember to take down website when they come up with an artist named 'error'.
		return {artist: null, music: null, error: true}
	}
	var artist = unescape(hash.split(':')[0] || '').capitalize(),
		music = unescape(hash.split(':')[1] || '').capitalize();
	return {artist: artist, music: music}
}

function searchSong (artist, song) {
	vagalume.getMusic(artist, song, function (data) {
		if (data.music) { // refine this
			new LyricsBox(data);
			scrollToContent();
		} else {
			new ErrorBox({artist:artist, song:song}, data);
		}
	});
}

/////////////

function substituteHash (newhash) {
	var newhash = "#!"+newhash.replace(/^#\!?/, '');
	location.hash = newhash;
	decideOnHash();
	// if (history && history.pushState)
	// 	history.pushState({module:"leave"}, document.title, this.href);
}

function decideOnHash () {
	// Decide what to do, based hashObj {String artist, String music}
	var hashObj = parseHash();
 	if (hashObj.error) {
 		new ErrorBox('something just hapenned :S');
	} else if (hashObj.artist && hashObj.music) {
		searchSong(hashObj.artist, hashObj.music);
	} else {
		new ErrorBox('Not all fields were specified. :(')
	}
}

(function () {
	var h = parseHash();
	updateForm(h)
	decideOnHash()
})();



</script>
</body>
</html>