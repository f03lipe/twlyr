<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<link rel="stylesheet" href="bootstrap/css/bootstrap.css"></link>
	<script src="jqmin1.7.js" charset="utf-8"/></script>
	<script src="vagalume.js" charset="utf-8"/></script>
	<script src="selector.js" charset="utf-8"/></script>

<style>

	#searchbar {
		display: table;
		margin: 0 auto;

		min-height: 20px;
		padding: 19px;
		margin-bottom: 20px;
		
		background-color: whiteSmoke;
		
		border: 1px solid #EEE;
		border: 1px solid rgba(0, 0, 0, 0.1);
		
		-webkit-border-radius: 4px;
		-moz-border-radius: 4px;
		border-radius: 4px;
		
		-webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
		-moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
		box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
	}

	#searchbar form {
		margin: 0;
	}

	#searchbar input[type=text] {
		line-height: 19px;
		font-size: 16px;
		padding: 9px;
		width: 200px;
		box-shadow: none;
	}

	#searchbar input[type=text]:hover {
		border-color: #08C;
		text-shadow: none;
	}

	#searchbar button NOT {
		border-top-left-radius: 0;
		border-bottom-left-radius: 0;
		border-top-right-radius: 5px;
		border-bottom-right-radius: 5px;
	}

	/****************/
	
	.container {
		width: 800px;
	}

	.verse {
		font: 15px "Open Sans", Arial;

		display: table;
		padding: 10px;
	}

	.line {
		font-size: 0; /* remove space between spans */
		/* text-align: justify; */
	}

	.word {
		font-size: 15px;
		padding: 2px 3px;
	}

	.word.selected {
		background: #08C;
		color: white;
	}

	.lyrics {
		float: right;
		-webkit-user-select: none;
		outline: 1px solid #ddd;

		min-height: 200px;
		width: 100%;
	}

	/****************/

	.box.left {
		width: 380px;
		float: left;
		padding: 10px 0;
	}

	.box.right {
		float: right;
		width: 400px;
	}

	/****************/

	textarea#tweet {
		width: 350px;
		font-size: 15px;
		height: 70px;
		resize: vertical;
	}

	.align-line {
		text-align: right;
		height: 30px;
	}

	.twtcounter {
		float: left;
		padding: 5px 10px;
	}
	.twtcounter.exceed { color: red; }

	.tweet-box {
		background: whiteSmoke;
		box-shadow: 0 0 0 1px #ddd;
		border-radius: 5px;
		padding: 10px;
	}

	.tweet-box.blue { background: #08C; }
	.tweet-box.blue .twtcounter { color: white; }

	#tweet-button {
		float: right;
		font-weight: bold;
	}

</style>

</head>
<body>

<div class="container">
	
	<div>
		<h2>Search a song</h2>
		<div id="searchbar">
			<form class="form-search">
				<input type="text" placeholder="le artist" class="input-medium search-query" id="search-artist">
				<input type="text" placeholder="le song" class="input-medium search-query" id="search-music">
				<button type="submit" class="btn btn-info btn-large">Search</button>
			</form>
		</div>
	</div>

	<div class="box left">
		
		<h4 id="artist-name"></h4>
		<h4 id="music-name"></h4>
		
		<br>

		<div class="tweet-box">
			<textarea id="tweet"></textarea>

			<div class="align-line">
				<div class="twtcounter">0</div>
				<button class="btn btn-success" id="tweet-button" onClick="openTweetPopup()">Tweet</button>
			</div>
		</div>
	</div>
	<div class="box right">
		<div class="lyrics">
		</div>
	</div>

</div>

<script>

function openTweetPopup () {
	var text = document.querySelector('#tweet').value
	window.open("https://twitter.com/intent/tweet?text="+escape(text))
}

function disableTweet () {
	var counter = document.querySelector('.twtcounter')
	counter.classList.add('exceed')
	document.querySelector('#tweet-button').classList.add('disabled')
}

function enableTweet () {
	var counter = document.querySelector('.twtcounter')
	counter.classList.remove('exceed')
	document.querySelector('#tweet-button').classList.remove('disabled')
}

function updateTweetCounter () {
	// update characters counter in tweet textarea
	var tweet =  document.querySelector('textarea#tweet').value,
		counter = document.querySelector('.twtcounter')
	
	counter.innerHTML = tweet.length
	if (tweet.length > 140)
		disableTweet()
	else enableTweet()
	
	return true;
}

function writeLyrics (text) {
	// write lyrics given text retrieved from vagalume's api
	// lines must be separated by '\n' and verses by empty lines

	var verses = text.split('\n\n')
		lyricstag = document.querySelector(".lyrics")

	// clean lyrics
	while (lyricstag.children[0])
		lyricstag.removeChild(lyricstag.children[0])

	// loop through verses
	for (var v, i=0; v=verses[i]; i++) {
		var vtag = document.createElement('div'),
			lines = v.split('\n')
		vtag.className = "verse"

		// loop through lines
		for (var l, i2=0; l=lines[i2]; i2++) {
			ltag = document.createElement('div'),
				words = l.split(' ')
			ltag.className = "line"

			// loop through words
			for (var w, i3=0; w=words[i3]; i3++) {
				var wtag = document.createElement('span')
				wtag.className = 'word'
				wtag.innerHTML = w

				ltag.appendChild(wtag)
			}

			vtag.appendChild(ltag)
		}

		lyricstag.appendChild(vtag)
	}

	Selector.addSelectionEvent()
}

(function () {

	var tweet = document.querySelector("textarea#tweet")
	tweet.addEventListener('focus', updateTweetCounter)
	tweet.addEventListener('keyup', updateTweetCounter)
	tweet.addEventListener('onchange', updateTweetCounter)

})();

$('#search-artist').val('Coldplay')
$('#search-music').val('The Scientist')


$('#searchbar form').submit(function () {
	vagalume.musicInfoFromName(
		$('#search-artist').val(),
		$('#search-music').val(),
		function () {
			console.log('oncaptcha', arguments)
		}, function (data) {
			d = data
			m = d.music[0]
			writeLyrics(m.lyrics)
			$("#music-name").html(d.music[0].name)
			$("#artist-name").html(d.artist.name)
		});
	return false
});


</script>
</body>
</html>