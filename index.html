<!DOCTYPE html>
<html>
<head>
	<title>Twlyr - Share a Verse!</title>
	<meta charset='utf-8'>

    <link href="css/bootstrap.css" rel="stylesheet" />
	<link href='css/main.css' rel='stylesheet' />
	<link href='http://fonts.googleapis.com/css?family=Berkshire+Swash|Courgette|Open+Sans|Karla' rel='stylesheet' type='text/css'>

	<script src='js/jquery.min.js'></script>
	<script src='js/bootstrap.min.js'></script>
	<script src='js/mustache.min.js'></script>

	<script src='js/boxes.js' charset='utf-8'></script>
	<script src='js/vagalume.js' charset='utf-8'></script>
</head>
<body>

	<div class='version-strip'>version 1.0</div>
	<div class="container face">
		<a class='twlyr' href=''>Twlyr</a>
		<h3 class='desc'>share a verse on Twitter!</h3>
		<form id='searchbar' class='form-search'>
			<input id='search-artist' type='text' autocomplete='off' placeholder='Choose an artist!' class='input-medium search-query'>
			<input id='search-song' type='text' autocomplete='off' placeholder='Choose a song!' class='input-medium search-query'>
			<button type='submit' class='button red'>Search</button>
		</form>
		<footer>
			2012 &reg; created by <a href='http://twitter.com/f03lipe'>f03lipe</a> and <a href='http://twitter.com/gabrielsoldani'>@gabrielsoldani</a>
		</footer>
	</div>

    <div class='container result'></div> <!-- must stay completely empty -->

<script id="lyrics-box-html" type="text/html">
    <div class="box-wrapper">

        <div class="box lyrics-box">
            <div class="msg">
                <h2>Hey, we've found something!</h2> <!-- ' -->
            </div>
            <div class="wrap-left">
                <div class="music-info-wrapper" style="margin-bottom: 20px">
                    <img onClick="substituteHash(encodeURIComponent('{{artist-name}}'))" src="{{pic-url}}"></img>
                    <div class='text' style="width: 166px">
                        artist: <h3 class="artist-name">{{artist-name}}</h3>
                        song: <h3 class="song-name">{{song-name}}</h3>
                        {{#album-name}}
                        from album<h3 class="album-name">{{album-name}}</h3>
                        {{/album-name}}
                    </div>
                </div>


                <div class="tweet-box">
                    <textarea class="tweet" placeholder="select the lyrics on the right to tweet..."></textarea>

                    <div class="align-line">
                        <div class="twtcounter">0</div>
                        <button class="tweet-button button green small" "btn btn-success tweet-button" onClick=" openTweetPopup() ">Tweet</button>
                    </div>
                </div>
                <div class="videoclip">
                    <iframe width="380" height="214" src="http://www.youtube.com/embed/{{youtubeId}}" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="wrap-right">
                <h5>{{artist-name}}'s {{song-name}} lyrics:</h5> <!--' -->
                <div class="lyrics"></div>
            </div>
        </div>

        <div class="separator"></div>
    </div>
</script>
<script id="list-box-html" type="text/html">
    <div class="box-wrapper">

        <div class="box lyrics-box">
            <div class="msg">
                {{#msg}}
                	{{{msg}}}
                {{/msg}}
                {{^msg}}
                	<h2>Here's a list of songs...</h2> <!-- ' -->
                {{/msg}}
            </div>
            <div class="wrap-left">
                <div class="music-info-wrapper" style="margin-bottom: 20px">
                    <img src="{{pic-url}}"></img>
                    <div class='text'>
                        artist: <h3>{{artist-name}}</h3>
                        lyrics available: <h3>{{num-lyrics}}</h3>
                    </div>
                </div>

            </div>
            <div class="wrap-right">
                <ul>
                    {{#songs}}
                    {{#.}} {{! double check it!}}
                    <li data-song="{{.}}" data-artist="{{artist-name}}">
                        <button onClick=" selectThisSong(this.parentElement) " class="btn btn-info">{{.}}</button>
                    </li>
                    {{/.}}
                    {{/songs}}
                </ul>
            </div>
        </div>

        <div class="separsator"></div>
    </div>
</script>
<script id="error-box-html" type="text/html">
    <div class="box-wrapper">
        <div class="box error-box">
            {{#unknown-error}}
            <h2>Unknown Error</h2>
            <h3>Something hapenned, but...</h3>
            {{/unknown-error}}

            {{#artist-404}}
            <h2>Artist {{artist-name}} was not found</h2> <!-- ' -->
            <h3>We're sorry. Are you sure you're spelling it correctly?</h3> <!-- ' -->
            {{/artist-404}}

            {{#song-404}}
            <h2>Song not found</h2>
            <h3>We couldn't find {{song-name}} by {{artist-name}}. </h3><!-- ' -->
            {{/song-404}}

            {{#general-error}}
            <h2>{{general-error}}</h2>
            {{/general-error}}
        </div>
    </div>
</script>


<script>

    SearchBar = new SearchBar();

    function selectThisSong(liObj) {
        substituteHash(encodeURIComponent(liObj.dataset.artist) + ":" + encodeURIComponent(liObj.dataset.song));
    }


    function scrollToContent(what) {
        var p = (what || document.querySelector(".container.result")).offsetTop;
        $('html, body').animate({ scrollTop: p }, {
                duration: 1000,
                step: function (e) {
                    window.forcedScroll = true;
                }
            });
    
    }

    $('body,html').bind('scroll mousedown DOMMouseScroll mousewheel keyup', function(e){
        if ( e.which > 0 || e.type == "mousedown" || e.type == "mousewheel"){
            $("html,body").stop();
        }
    })



    function updateForm(hashObj) {
        document.querySelector("#search-artist").value = hashObj.artist;
        document.querySelector("#search-song").value = hashObj.song;
    }

    document.querySelector("form.form-search").onsubmit = function() {
        var artist = document.querySelector("#search-artist").value.toLowerCase().trim(),
            song = document.querySelector("#search-song").value.toLowerCase().trim();
        if (artist && song)
            substituteHash("#!" + encodeURIComponent(artist) + ":" + encodeURIComponent(song));
        return false;
    };

    function parseHash(hashUrl) {
        // Return {String artist, String song} based on location.hash.
        var hash = (hashUrl || location.hash).replace(/^#\!?/, ''); // remove #! from beginning
        if (hash === 'error') {
            // Remember to take down website when they come up with an artist named 'error'.
            return { artist: null, song: null, error: true };
        }
        var artist = decodeURIComponent(hash.split(':')[0] || '').capitalize(),
            song = decodeURIComponent(hash.split(':')[1] || '').capitalize();
        return { artist: artist, song: song };
    }

    function searchSong(artist, song) {
        vagalume.getTrackInfoFromName(artist, song, function() {
        }, function(data) {
            var box;
            if (!data.artist) {
                box = new ErrorBox({ artist: artist, song: song }, data);
            } else if (!data.song) {
                var html = "<h2>We couldn't find {{song}}</h2><h3>But here's a list of songs by {{artist}}</h3>";
                searchSongsBy(artist, Mustache.render(html, { artist: artist, song: song }));
            } else {
                box = new LyricsBox(data);
                scrollToContent();
            }
        });
    }

    function searchSongsBy(artist, msg) {
        vagalume.getArtistSongs(artist, function(data) {
            if (!data || data.type === 'notfound')
                return;
            var box = new ListBox({ artist: artist }, data, msg);
            scrollToContent();
        });
    }

    /////////////

    function substituteHash(newhash) {
        newhash = "#!" + newhash.replace(/^#\!?/, '');
        location.hash = newhash;
        decideOnHash();
        // if (history && history.pushState)
        // 	history.pushState({module:"leave"}, document.title, this.href);
    }

    function decideOnHash() {
        // Decide what to do, based hashObj {String artist, String song}
        var hashObj = parseHash();
        if (!hashObj.artist && !hashObj.song) {
            return; // Do nothing when fields aren't selected.
        } else {
            var box;
            if (hashObj.error) {
                box = new ErrorBox('something just hapenned :S');
            } else if (hashObj.artist && hashObj.song) {
                searchSong(hashObj.artist, hashObj.song);
            } else if (hashObj.artist && !hashObj.song) {
                searchSongsBy(hashObj.artist);
            } else {
                box = new ErrorBox('Not all fields were specified. :(');
            }
        }
    }

    (function() {
        var h = parseHash();
        updateForm(h);
        decideOnHash();
    })();
</script>
</body>
</html>
