<!DOCTYPE html>
<html>
<head>	
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Twlyr - Share a Song!</title>

	<link href="bootstrap/css/bootstrap.css" rel="stylesheet"></link>
	<link href='main.css' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Berkshire+Swash|Courgette' rel='stylesheet' type='text/css'>

	<script src="js/jquery.min.js" charset="utf-8"></script>
	<script src="js/vagalume.js" charset="utf-8"></script>
	<script src="js/selector.js" charset="utf-8"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>

	<style>
	.container { margin-top: 200px; }
	</style>
</head>
<body>

<div class="beta-strip">Beta v1.0</div>

<div class="container">

	<h1 class="twlyr">Twlyr</h1>
	<h3 class="desc">share a verse on Twitter!</h3>
	
	<div>
		<div id="searchbar">
			<form class="form-search">
				<input type="text" autocomplete="off" placeholder="choose an artist" class="input-medium search-query" id="search-artist">
				<input type="text" autocomplete="off" placeholder="choose a song" class="input-medium search-query" id="search-music">
				<button type="submit" class="btn btn-warning btn-large">Search</button>
			</form>
		</div>
	</div>

	<footer>
		2012 &reg created by <a href="#">@f03lipe</a> and <a href="#">@gabrielvianna</a>
	</footer>

	<!--
	<div class="blackout">
		<div>
			<img src="images/loading.gif"></img>
		</div>
	</div>
	-->

</div>
<script>

function toVagalumeName (name) {
	// noobs!
	return String(name).toLowerCase().replace(/\s+/,'-');
}

var thismonth = "http://www.vagalume.com.br/api/rank.php?type=art&period=month&limit=300&scope=internacional&period=month,lastmonth"
var lastmonth = "http://www.vagalume.com.br/api/rank.php?type=art&period=month&limit=300&scope=internacional&period=lastmonth"

function getTopArtists (callback) {
	$.getJSON(thismonth, function (data) {
		var top = data.art.month.internacional,
			artists = [];
		for (var i=0; i<top.length; i++)
			artists.push(top[i].name);
		callback(artists)
	})
}

function processMusicName (name) {
	return String(name).replace(/\s?\(.*$/, '')
}

function inArray (value, array) {
	for (var i=0; i<array.length; i++)
		if (array[i] === value)
			return true;
	return false;
}

function getArtistLyrics (artist, callback, onerror) {
	var url = 'http://www.vagalume.com.br/'+toVagalumeName(artist)+'/index.js';
	console.log(url)
	$.getJSON(url, function (data) {
		if (!data.artist) {
			onerror()
			return
		}
		var all = data.artist.lyrics.item,
			lyrics = [];
		for (var i=0; i<all.length; i++) {
			if (inArray(processMusicName(all[i].desc),lyrics))
				continue;
			lyrics.push(processMusicName(all[i].desc));
		}
		callback(lyrics);
	})
}

$("#search-artist").focus(function () {
	getTopArtists(function (list) {
		console.log('adding', list.length, list)
		$("#search-artist").typeahead({
			source: list,
		});
	});
})

$("#search-music").focus(function () {
	var v = $("#search-artist").val();
	if (v != '') {
		getArtistLyrics(v, function (list) {
			console.log(list)
			$("#search-music").typeahead({
				source: list
			})
		})
	}
})

document.querySelector('#searchbar form').onsubmit = function () {
	var artist = encodeURIComponent(document.querySelector('#search-artist').value);
	var music = encodeURIComponent(document.querySelector('#search-music').value);
	window.location.hash = '#!search:' + artist + ':' + music;
	return false;
}

(function (){
	var parseHash = function (hash) {
		var ret = 'default';
		if (!hash || hash.length < 4 || hash.slice(0, 2) !== '#!')
			return ret;
		return hash.slice(2).split(':')[0];
	};
	var currentHash = false;
	setInterval(function () {
		if (window.location.hash !== currentHash) {
			var pagename = parseHash(window.location.hash);
			currentHash = window.location.hash;
			$('#content').html('');
			$.ajax({
				url: pagename + '.html',
				async: true,
				cache: true,
				error: function (){
					console.log('ajax error');
				},
				type: 'GET',
				dataType: 'html',
				timeout: 10000,
				success: function (html) {
					$('#content').html(html);
					$.ajax({
						url: pagename + '.js',
						async: true,
						cache: true,
						error: function (){
							console.log('ajax error');
						},
						type: 'GET',
						dataType: 'script',
						timeout: 10000,
					});
				},
			});
		}
	}, 100);
}());

</script>

</body>
</html>